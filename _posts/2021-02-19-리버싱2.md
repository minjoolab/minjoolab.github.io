---
title: "[정보보안공부]PE 파일이 메모리에 적재되기까지의 과정"
categories: 정보보안SUA, reversing
comments: true
---

## PE파일이 어떻게 메모리에 적재되는지, 이러한 과정이 왜 필요한지

### PE(Portable Executable) 파일이란?  
Win32 운영체제라면 어디에서도 잘 돌아가는 파일 포맷
<br/>
PE 구조를 통해 파일이 실행되기 위한 정보들을 볼 수 있고, 파일 실행시 코드가 실행되기 전에 PE 파일을 읽어들여 바이너리를 메모리에 올리기 위한 데이터 설정 작업을 한다.  
PE 헤더에는 실행 파일을 실행시키기 위한 각종 정보(메모리 적재 방법, 실행 위치, 필요한 DLL 목록 등)이 기록되어있다.

### PE 파일의 종류
실행 파일 계열(exe, scr), 라이브러리 계열(dll, ocx), 드라이버 계열(sys), 오브젝트 파일 계열(obj)이 있다.  
obj를 제외한 나머지 파일들은 실행 가능한 파일이다.  
dll, sys파일 등은 쉘에서 직접 실행이 불가하지면 디버거나 기타 서비스등을 통해 실행이 가능하다.

### PE 파일의 구조
![pe](/assets/img/pe.jpg)  
+ PE Header : DOS header부터 Section header까지, PE Body : PE Header 밑의 Section들  
+ PE Header의 끝부분과 각 Section들의 끝에는 NULL padding 영역이 존재한다.  
  + 컴퓨터 효율을 높이기 위해 최소 기본 단위 개념을 사용하는 것이 PE파일에 적용된 것이다.  
  + 파일/메모리에서 섹션의 시작위치는 각 파일/메모리의 최소 기본 단위의 배수에 해당하는 위치여야하고, 빈 공간은 NULL로 채워진다.  
+ 파일의 내용은 코드, 데이터, 리소스 섹션에 나뉘어서 저장된다.  
+ 파일에서는 offset으로 위치를 표현하고, 메모리에서는 VA(Virtual Address)로 위치를 표현한다.  
+ 파일이 메모리에 로딩되면 Section의 크기, 위치 등이 달라진다.  
+ PE가 메모리에 적재되기 전에 기본 ImageBase는 0이며, PE안에서는 재배치를 위해 RVA(상대주소)를 사용한다.   
+ 상대주소(RVA)와 절대주소(VA)의 관계는 다음과 같다.  
  + RVA+ImageBase(기준위치)=VA
  + PE 파일이 프로세스 가상메모리의 특정 위치에 로딩되는 순간 그 위치에 다른 PE파일이 로딩된다면 재배치를 통해 비어있는 다른 자리에 로딩한다.  
  + 이때 PE 헤더의 정보들이 VA로 되어있다면 정상적인 엑세스가 이뤄지기 힘드므로 상대주소를 사용해서 재배치가 발생해도 문제없이 엑세스할 수 있도록 한다.
